<!DOCTYPE html>
<html lang="fr">

<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Parking-SAE</title>
  <link rel="icon" href="./vue/style/Logo.png" />
  <link rel="stylesheet" href="./api/leaflet/dist/leaflet.css" />
  <link rel="stylesheet" href="./vue/style/style.css" />
</head>

<body>
  <!-- Loader -->
  <div id="loaderContainer">
    <span id="loader"></span>
    <h4>Chargement en cours...</h4>
  </div>

  <!-- Carte -->
  <div id="map"></div>

  <!-- Panel utilisateur -->
  <div id="userPanel">
    <h3>Profil</h3>
    <p id="userName">Nom : ...</p>
    <div id="vehicleType">
      <label><input type="radio" name="vehicle" value="car"> Voiture</label><br>
      <label><input type="radio" name="vehicle" value="electric"> Électrique</label><br>
      <label><input type="radio" name="vehicle" value="motorcycle"> Moto</label><br>
      <label><input type="radio" name="vehicle" value="bike"> Vélo</label>
    </div>

    <h3>Parkings favoris</h3>
    <div id="favoritesList"></div>
  </div>

  <!-- Infos itinéraire -->
  <div id="routeInfo"></div>
  <button id="routeBtn">Aller au parking le plus proche</button>

  <script src="./api/leaflet/dist/leaflet.js"></script>

  <script type="module">
    import { MobileApp } from "./module/MobileApp.js";
    import { UserProfile } from "./module/modele/UserProfile.js";

    async function initApp() {
      const loader = document.getElementById("loaderContainer");
      const favoritesList = document.getElementById("favoritesList");
      const vehicleRadios = document.querySelectorAll("#vehicleType input[name='vehicle']");

      try {
        const res = await fetch("./vue/get_profile.php", { credentials: "include" });
        const data = await res.json();

        if (!data.connected) {
          alert("Utilisateur non connecté. Veuillez vous connecter.");
          window.location.href = "connexion.php";
          return;
        }

        // Créer UserProfile
        const user = new UserProfile({
          name: data.profile.name,
          surname: data.profile.surname,
          vehicleType: data.profile.vehicleType,
          preferences: []
        });

        document.getElementById("userName").textContent = `Nom : ${user.getName()}`;

        // Initialiser le type de véhicule
        vehicleRadios.forEach(radio => {
          radio.checked = (radio.value === user.getVehicleType());
          radio.addEventListener("change", async (e) => {
            const v = e.target.value;
            const resp = await fetch("./vue/set_vehicle.php", {
              method: "POST",
              credentials: "include",
              headers: { "Content-Type": "application/json" },
              body: JSON.stringify({ vehicleType: v })
            });
            const result = await resp.json();
            if(result.success){
              alert("Type de véhicule mis à jour !");
              user._vehicleType = v; // mettre à jour localement
            }
          });
        });

        // Afficher les favoris
        function renderFavorites() {
          favoritesList.innerHTML = "";
          data.favorites.forEach(f => {
            const div = document.createElement("div");
            div.className = "favorite-item";
            div.innerHTML = `
              <span>${f.name}</span>
              <span>
                <button class="goFav" data-id="${f.parking_id}">Aller</button>
                <button class="removeFav" data-id="${f.parking_id}">Supprimer</button>
              </span>
            `;
            favoritesList.appendChild(div);
          });
        }
        renderFavorites();

        // Instancier l'application
        const app = new MobileApp(user);
        await app.start();

        // Bouton itinéraire vers le parking le plus proche
        const routeBtn = document.getElementById("routeBtn");
        const routeInfo = document.getElementById("routeInfo");

        routeBtn.addEventListener("click", async () => {
          if(!app.userPos || !app.nearestParking){
            alert("Position en cours de récupération");
            return;
          }
          app.map.setNearestParkingMarker(app.nearestParking);
          app.startTracking();

          routeBtn.disabled = true;
          routeBtn.textContent = "Itinéraire affiché";

          const result = await app.showRoute(app.userPos, app.nearestParking.location);
          if(result){
            routeInfo.textContent = `Distance : ${result.distanceKm} km | Durée : ${result.duration}`;
            routeInfo.style.display = "block";
          }
        });

        // Boutons aller / supprimer favoris
        favoritesList.addEventListener("click", async (e) => {
          if(e.target.classList.contains("goFav")){
            const parkingId = e.target.dataset.id;
            const park = app.parkCtrl.parkings.find(p => p.parking_id == parkingId);
            if(park){
              app.nearestParking = park;
              app.map.setNearestParkingMarker(app.nearestParking);
              app.startTracking();
              const result = await app.showRoute(app.userPos, app.nearestParking.location);
              if(result){
                routeInfo.textContent = `Distance : ${result.distanceKm} km | Durée : ${result.duration}`;
                routeInfo.style.display = "block";
              }
            }
          } else if(e.target.classList.contains("removeFav")){
            const parkingId = e.target.dataset.id;
            const resp = await fetch("./vue/remove_favorite.php", {
              method: "POST",
              credentials: "include",
              headers: { "Content-Type": "application/json" },
              body: JSON.stringify({ parkingId })
            });
            const result = await resp.json();
            if(result.success){
              alert("Favori supprimé !");
              data.favorites = data.favorites.filter(f => f.parking_id != parkingId);
              renderFavorites();
            }
          }
        });

      } catch(err){
        console.error("Erreur initialisation :", err);
        alert("Impossible de charger l'application.");
      } finally {
        loader.style.display = "none";
      }
    }

    initApp();
  </script>
</body>

</html>
