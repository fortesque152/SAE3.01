<!DOCTYPE html>
<html lang="fr">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Parking-SAE</title>
    <link rel="icon" href="./vue/style/Logo.png" />
    <link rel="stylesheet" href="./api/leaflet/dist/leaflet.css" />
    <link rel="stylesheet" href="./vue/style/style.css" />
    <style>
      /* Panel utilisateur */
      #panelToggle {
        position: absolute;
        top: 20px;
        right: 20px;
        z-index: 1001;
        padding: 8px 12px;
        background: #0078ff;
        color: #fff;
        border: none;
        border-radius: 6px;
        cursor: pointer;
      }

      #userPanel {
        position: fixed;
        top: 0;
        right: -320px;
        width: 300px;
        height: 100%;
        background: #f9f9f9;
        box-shadow: -2px 0 6px rgba(0, 0, 0, 0.2);
        padding: 20px;
        box-sizing: border-box;
        transition: right 0.3s ease-in-out;
        z-index: 1000;
        overflow-y: auto;
      }

      #userPanel.open { right: 0; }

      #panelHeader {
        display: flex;
        justify-content: space-between;
        align-items: center;
      }

      #panelHeader h3 { margin: 0; }
      #panelClose { background: none; border: none; font-size: 24px; cursor: pointer; }

      .favorite-item {
        display: flex;
        justify-content: space-between;
        align-items: center;
        padding: 4px 0;
        border-bottom: 1px solid #ddd;
        font-size: 14px;
      }

      .favorite-item button { margin-left: 4px; padding: 2px 6px; font-size: 12px; cursor: pointer; }

      /* Formulaire ajout véhicule */
      #addVehicleForm { margin-top: 10px; border-top: 1px solid #ccc; padding-top: 10px; }
      #addVehicleForm input, #addVehicleForm select, #addVehicleForm button {
        margin-top: 5px; width: 100%; padding: 6px; box-sizing: border-box;
      }

      @media (max-width: 768px) { #userPanel { width: 80%; } }
    </style>
  </head>

  <body>
    <div id="loaderContainer">
      <span id="loader"></span>
      <h4>Chargement en cours...</h4>
    </div>

    <div id="map"></div>
    <button id="panelToggle">Profil</button>

    <div id="userPanel">
      <div id="panelHeader">
        <h3>Profil</h3>
        <button id="panelClose">&times;</button>
      </div>

      <p id="userName">Nom : ...</p>

      <h4>Type de véhicule</h4>
      <div id="vehicleType"></div>

      <!-- Formulaire ajout véhicule -->
      <form id="addVehicleForm">
        <h4>Ajouter un véhicule</h4>
        <input type="text" id="vehicleName" placeholder="Nom du véhicule" required />
        <select id="vehicleTypeSelect">
          <option value="car">Voiture</option>
          <option value="electric">Électrique</option>
          <option value="motorcycle">Moto</option>
          <option value="bike">Vélo</option>
        </select>
        <button type="submit">Ajouter</button>
      </form>

      <h4>Parkings favoris</h4>
      <div id="favoritesList"></div>
    </div>

    <div id="routeInfo"></div>
    <button id="routeBtn">Aller au parking le plus proche</button>

    <script src="./api/leaflet/dist/leaflet.js"></script>
    <script type="module">
      import { MobileApp } from "./module/MobileApp.js";
      import { UserProfile } from "./module/modele/UserProfile.js";

      async function initApp() {
        const loader = document.getElementById("loaderContainer");
        const vehicleTypeDiv = document.getElementById("vehicleType");
        const vehicleNameInput = document.getElementById("vehicleName");
        const vehicleTypeSelect = document.getElementById("vehicleTypeSelect");
        const addVehicleForm = document.getElementById("addVehicleForm");
        const favoritesList = document.getElementById("favoritesList");
        const panelToggle = document.getElementById("panelToggle");
        const panelClose = document.getElementById("panelClose");
        const userPanel = document.getElementById("userPanel");

        // Toggle panel
        panelToggle.addEventListener("click", () => userPanel.classList.add("open"));
        panelClose.addEventListener("click", () => userPanel.classList.remove("open"));

        try {
          const res = await fetch("./vue/get_profile.php", { credentials: "include" });
          const data = await res.json();

          if (!data.connected) {
            alert("Utilisateur non connecté. Veuillez vous connecter.");
            window.location.href = "index.php";
            return;
          }

          const user = new UserProfile({
            profile_id: data.profile.profile_id,
            profile_name: data.profile.name,
            is_pmr: data.profile.is_pmr || false,
            vehicles: data.profile.vehicles || [],
            preferences: data.profile.preferences || [],
          });

          document.getElementById("userName").textContent = "Nom : " + (user.getName() || "Inconnu");

          // Affichage des véhicules
          function renderVehicles() {
            vehicleTypeDiv.innerHTML = "";
            const userVehicles = user.getVehicles();
            if (userVehicles.length === 0) {
              vehicleTypeDiv.textContent = "Aucun véhicule enregistré";
            } else {
              userVehicles.forEach((v, i) => {
                const label = document.createElement("label");
                label.innerHTML = `<input type="radio" name="vehicle" value="${v.name}" ${i === 0 ? "checked" : ""}> ${v.name} (${v.type})`;
                vehicleTypeDiv.appendChild(label);
                const input = label.querySelector("input");
                input.addEventListener("change", async e => {
                  const vehicleName = e.target.value;
                  await fetch("./vue/set_vehicle.php", {
                    method: "POST",
                    credentials: "include",
                    headers: { "Content-Type": "application/json" },
                    body: JSON.stringify({ vehicleName })
                  });
                });
              });
            }
          }
          renderVehicles();

          // Formulaire ajout véhicule
          addVehicleForm.addEventListener("submit", async e => {
            e.preventDefault();
            const name = vehicleNameInput.value.trim();
            const type = vehicleTypeSelect.value;
            if(!name) return alert("Entrez un nom de véhicule");

            const resp = await fetch("./vue/add_vehicle.php", {
              method: "POST",
              credentials: "include",
              headers: { "Content-Type": "application/json" },
              body: JSON.stringify({ name, type })
            });
            const result = await resp.json();
            if(result.success){
              user.addVehicle({ name, type });
              renderVehicles();
              vehicleNameInput.value = "";
              alert("Véhicule ajouté !");
            } else {
              alert("Erreur lors de l'ajout du véhicule");
            }
          });

          // Affichage des favoris
          function renderFavorites() {
            favoritesList.innerHTML = "";
            (data.favorites || []).forEach(f => {
              const div = document.createElement("div");
              div.className = "favorite-item";
              div.innerHTML = `
                <span>${f.name}</span>
                <span>
                  <button class="goFav" data-id="${f.parking_id}">Aller</button>
                  <button class="removeFav" data-id="${f.parking_id}">Supprimer</button>
                </span>
              `;
              favoritesList.appendChild(div);
            });
          }
          renderFavorites();

          const app = new MobileApp(user);
          await app.start();

          const routeBtn = document.getElementById("routeBtn");
          const routeInfo = document.getElementById("routeInfo");

          // Bouton itinéraire
          routeBtn.addEventListener("click", async () => {
            if(!app.userPos || !app.nearestParking) return alert("Position en cours de récupération");
            app.map.setNearestParkingMarker(app.nearestParking);
            app.startTracking();
            routeBtn.disabled = true;
            routeBtn.textContent = "Itinéraire affiché";
            const result = await app.showRoute(app.userPos, app.nearestParking.location);
            if(result){
              routeInfo.textContent = `Distance : ${result.distanceKm} km | Durée : ${result.duration}`;
              routeInfo.style.display = "block";
            }
          });

          // Gestion des favoris
          favoritesList.addEventListener("click", async (e) => {
            if(e.target.classList.contains("goFav")){
              const id = e.target.dataset.id;
              const park = app.parkCtrl.parkings.find(p => p.parking_id == id);
              if(park){
                app.nearestParking = park;
                app.map.setNearestParkingMarker(park);
                app.startTracking();
              }
            } else if(e.target.classList.contains("removeFav")){
              const id = e.target.dataset.id;
              const resp = await fetch("./vue/remove_favorite.php", {
                method: "POST",
                credentials: "include",
                headers: { "Content-Type": "application/json" },
                body: JSON.stringify({ parkingId: id }),
              });
              const result = await resp.json();
              if(result.success){
                data.favorites = data.favorites.filter(f => f.parking_id != id);
                renderFavorites();
              }
            }
          });

        } catch(err){
          console.error("Erreur initialisation :", err);
          alert("Impossible de charger l'application.");
        } finally {
          loader.style.display = "none";
        }
      }

      initApp();
    </script>
  </body>
</html>
