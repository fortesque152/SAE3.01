<!DOCTYPE html>
<html lang="fr">
  <head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Parking-SAE</title>
    <link rel="icon" href="./vue/style/Logo.png">
    <link rel="stylesheet" href="./api/leaflet/dist/leaflet.css">
    <link rel="stylesheet" href="./vue/style/style.css">
  </head>
  <body>
    <!-- Loader -->
    <div id="loaderContainer">
      <span id="loader"></span>
      <h4>Chargement en cours...</h4>
    </div>

    <!-- Carte -->
    <div id="map"></div>

    <!-- Bouton panel -->
    <button id="panelToggle">Profil</button>

    <!-- Panel utilisateur -->
    <div id="userPanel">
      <div id="panelHeader">
        <h3>Profil</h3>
        <button id="panelClose">&times;</button>
      </div>

      <p id="userName">Nom : ...</p>

      <h4>Véhicules</h4>
      <div id="vehicleType"></div>

      <button id="showAddVehicleBtn">Ajouter un véhicule</button>

      <form id="addVehicleForm">
        <input
          type="text"
          id="vehicleName"
          placeholder="Nom du véhicule"
          required
        >
        <select id="vehicleTypeSelect">
          <option value="car">Voiture</option>
          <option value="electric">Électrique</option>
          <option value="motorcycle">Moto</option>
        </select>
        <button type="submit">Ajouter</button>
      </form>

      <h4>Parkings favoris</h4>
      <div id="favoritesList"></div>
    </div>

    <!-- Infos itinéraire -->
    <div id="routeInfo"></div>
    <button id="routeBtn">Aller au parking le plus proche</button>

    <script src="./api/leaflet/dist/leaflet.js"></script>
    <script type="module">
      import { MobileApp } from "./module/MobileApp.js";
      import { UserProfile } from "./module/modele/UserProfile.js";

      async function initApp() {
        const loader = document.getElementById("loaderContainer");
        const vehicleTypeDiv = document.getElementById("vehicleType");
        const vehicleNameInput = document.getElementById("vehicleName");
        const vehicleTypeSelect = document.getElementById(
          "vehicleTypeSelect",
        );
        const addVehicleForm = document.getElementById(
          "addVehicleForm",
        );
        const showAddVehicleBtn = document.getElementById(
          "showAddVehicleBtn",
        );
        const favoritesList = document.getElementById("favoritesList");
        const panelToggle = document.getElementById("panelToggle");
        const panelClose = document.getElementById("panelClose");
        const userPanel = document.getElementById("userPanel");

        // Panel toggle
        panelToggle.addEventListener(
          "click",
          () => userPanel.classList.add("open"),
        );
        panelClose.addEventListener(
          "click",
          () => userPanel.classList.remove("open"),
        );

        // Toggle formulaire ajout véhicule
        showAddVehicleBtn.addEventListener("click", () => {
          addVehicleForm.style.display =
            addVehicleForm.style.display === "none" ? "block" : "none";
        });

        try {
          const res = await fetch("./vue/get_profile.php", {
            credentials: "include",
          });
          const data = await res.json();
          if (!data.connected) {
            alert("Non connecté");
            window.location.href = "index.php";
            return;
          }
          console.log(data);
          const user = new UserProfile({
            profile_id: data.profile.profile_id,
            profile_name: data.profile.name,
            is_pmr: data.profile.is_pmr || false,
            vehicles: data.profile.vehicles || [],
            preferences: data.profile.preferences || [],
          });

          document.getElementById("userName").textContent = "Nom : " +
            (user.getName() || "Inconnu");

          // Render véhicules
          function renderVehicles() {
            vehicleTypeDiv.innerHTML = "";
            const userVehicles = user.getVehicles();
            if (userVehicles.length === 0) {
              vehicleTypeDiv.textContent = "Aucun véhicule";
              return;
            }
            userVehicles.forEach((v, i) => {
              const label = document.createElement("label");
              label.innerHTML =
                `<input type="radio" name="vehicle" value="${v.vehicle_name}" ${
                  i === 0 ? "checked" : ""
                }> ${v.vehicle_name} (${v.name})`;
              vehicleTypeDiv.appendChild(label);
              const input = label.querySelector("input");
              input.addEventListener("change", async (e) => {
                await fetch("./vue/set_vehicule.php", {
                  method: "POST",
                  credentials: "include",
                  headers: { "Content-Type": "application/json" },
                  body: JSON.stringify({ vehicleName: e.target.value }),
                });
              });
            });
          }
          await user.reloadVehicles();
          renderVehicles();

          // Ajout véhicule
          addVehicleForm.addEventListener("submit", async (e) => {
            e.preventDefault();
            const name = vehicleNameInput.value.trim();
            const type = vehicleTypeSelect.value;
            if (!name) return alert("Entrez un nom");

            const resp = await fetch("./vue/add_vehicule.php", {
              method: "POST",
              credentials: "include",
              headers: { "Content-Type": "application/json" },
              body: JSON.stringify({ name, type }),
            });
            const result = await resp.json();
            console.log(result);
            if (result.success) {
              user.addVehicle({
                name: result.vehicle.name,
                type: result.vehicle.type,
              });
              renderVehicles();
              vehicleNameInput.value = "";
              addVehicleForm.style.display = "none";
              alert("Véhicule ajouté !");
            } else {
              alert("Erreur ajout véhicule");
            }
          });

          // Render favoris
          function renderFavorites() {
            favoritesList.innerHTML = "";
            (data.favorites || []).forEach((f) => {
              const div = document.createElement("div");
              div.className = "favorite-item";
              div.innerHTML = `<span>${f.name}</span><span>
              <button class="goFav" data-id="${f.parking_id}">Aller</button>
              <button class="removeFav" data-id="${f.parking_id}">Supprimer</button></span>`;
              favoritesList.appendChild(div);
            });
          }
          renderFavorites();

          const app = new MobileApp(user);
          await app.start();

          const routeBtn = document.getElementById("routeBtn");
          const routeInfo = document.getElementById("routeInfo");

          routeBtn.addEventListener("click", async () => {
            if (!app.userPos || !app.nearestParking) {
              alert("Position en cours");
              return;
            }
            app.map.setNearestParkingMarker(app.nearestParking);
            app.startTracking();
            routeBtn.disabled = true;
            routeBtn.textContent = "Itinéraire affiché";
            const result = await app.showRoute(
              app.userPos,
              app.nearestParking.location,
            );
            if (result) {
              routeInfo.textContent =
                `Distance : ${result.distanceKm} km | Durée : ${result.duration}`;
              routeInfo.style.display = "block";
            }
          });

          favoritesList.addEventListener("click", async (e) => {
            if (e.target.classList.contains("goFav")) {
              const id = e.target.dataset.id;
              const park = app.parkCtrl.parkings.find((p) =>
                p.parking_id == id
              );
              if (park) {
                app.nearestParking = park;
                app.map.setNearestParkingMarker(park);
                app.startTracking();
              }
            } else if (e.target.classList.contains("removeFav")) {
              const id = e.target.dataset.id;
              const resp = await fetch("./vue/remove_favorite.php", {
                method: "POST",
                credentials: "include",
                headers: { "Content-Type": "application/json" },
                body: JSON.stringify({ parkingId: id }),
              });
              const result = await resp.json();
              if (result.success) {
                data.favorites = data.favorites.filter((f) =>
                  f.parking_id != id
                );
                renderFavorites();
              }
            }
          });
        } catch (err) {
          console.error("Erreur init :", err);
          alert("Impossible de charger l'application");
        } finally {
          loader.style.display = "none";
        }
      }

      initApp();
    </script>
  </body>
</html>
