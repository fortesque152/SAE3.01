<!DOCTYPE html>
<html lang="fr">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Parking-SAE</title>
    <link rel="icon" href="./vue/style/Logo.png" />
    <link rel="stylesheet" href="./api/leaflet/dist/leaflet.css" />
    <link rel="stylesheet" href="./vue/style/style.css" />
  </head>

  <body>
    <!-- Loader -->
    <div id="loaderContainer">
      <span id="loader"></span>
      <h4>Chargement en cours...</h4>
    </div>

    <!-- Carte -->
    <div id="map"></div>

    <!-- Bouton pour ouvrir le panel utilisateur -->
    <button id="panelToggle">Profil</button>

    <!-- Panel utilisateur coulissant -->
    <div id="userPanel">
      <div id="panelHeader">
        <h3>Profil</h3>
        <button id="panelClose">&times;</button>
      </div>

      <p id="userName">Nom : ...</p>

      <h4>Type de véhicule</h4>
      <div id="vehicleType">
        <!-- Radios insérées dynamiquement -->
      </div>

      <h4>Parkings favoris</h4>
      <div id="favoritesList">
        <!-- Favoris insérés dynamiquement -->
      </div>
    </div>

    <!-- Infos itinéraire -->
    <div id="routeInfo"></div>
    <button id="routeBtn">Aller au parking le plus proche</button>

    <script src="./api/leaflet/dist/leaflet.js"></script>
    <script type="module">
      import { MobileApp } from "./module/MobileApp.js";
      import { UserProfile } from "./module/modele/UserProfile.js";

      async function initApp() {
        const loader = document.getElementById("loaderContainer");
        const vehicleTypeDiv = document.getElementById("vehicleType");
        const favoritesList = document.getElementById("favoritesList");
        const panelToggle = document.getElementById("panelToggle");
        const panelClose = document.getElementById("panelClose");
        const userPanel = document.getElementById("userPanel");

        // Toggle panel
        panelToggle.addEventListener(
          "click",
          () => userPanel.classList.add("open"),
        );
        panelClose.addEventListener(
          "click",
          () => userPanel.classList.remove("open"),
        );

        try {
          const res = await fetch("./vue/get_profile.php", {
            credentials: "include",
          });
          const data = await res.json();
          console.log(data);
          if (!data.connected) {
            alert("Utilisateur non connecté. Veuillez vous connecter.");
            window.location.href = "index.php";
            return;
          }

          // Création de l'utilisateur
          const user = new UserProfile({
            profile_id: data.profile.profile_id,
            profile_name: data.profile.name,
            is_pmr: data.profile.is_pmr || false,
            vehicles: data.profile.vehicles || [],
            preferences: data.profile.preferences || [],
          });

          // Affichage du nom
          document.getElementById("userName").textContent = "Nom : " +
            (user.getName() || "Inconnu");

          const userVehicles = user.getVehicles(); // maintenant c'est toujours un tableau
          if (userVehicles.length > 0) {
            userVehicles.forEach((v, i) => {
              const label = document.createElement("label");
              label.innerHTML = `
      <input type="radio" name="vehicle" value="${v.name}" ${
                i === 0 ? "checked" : ""
              }> ${v.name}
    `;
              vehicleTypeDiv.appendChild(label);

              const input = label.querySelector("input");
              if (input) {
                input.addEventListener("change", async (e) => {
                  const vehicleType = e.target.value;
                  const resp = await fetch("./vue/set_vehicle.php", {
                    method: "POST",
                    credentials: "include",
                    headers: { "Content-Type": "application/json" },
                    body: JSON.stringify({ vehicleType }),
                  });
                  const result = await resp.json();
                  if (result.success) {
                    alert("Type de véhicule mis à jour !");
                  }
                });
              }
            });
          } else {
            vehicleTypeDiv.textContent = "Aucun véhicule enregistré";
          }

          // Affichage des favoris
          function renderFavorites() {
            favoritesList.innerHTML = "";
            (data.favorites || []).forEach((f) => {
              const div = document.createElement("div");
              div.className = "favorite-item";
              div.innerHTML = `
              <span>${f.name}</span>
              <span>
                <button class="goFav" data-id="${f.parking_id}">Aller</button>
                <button class="removeFav" data-id="${f.parking_id}">Supprimer</button>
              </span>
            `;
              favoritesList.appendChild(div);
            });
          }
          renderFavorites();

          // Initialiser l'application
          const app = new MobileApp(user);
          await app.start();

          const routeBtn = document.getElementById("routeBtn");
          const routeInfo = document.getElementById("routeInfo");

          routeBtn.addEventListener("click", async () => {
            if (!app.userPos || !app.nearestParking) {
              alert("Position en cours de récupération");
              return;
            }
            app.map.setNearestParkingMarker(app.nearestParking);
            app.startTracking();

            routeBtn.disabled = true;
            routeBtn.textContent = "Itinéraire affiché";

            const result = await app.showRoute(
              app.userPos,
              app.nearestParking.location,
            );
            if (result) {
              routeInfo.textContent =
                `Distance : ${result.distanceKm} km | Durée : ${result.duration}`;
              routeInfo.style.display = "block";
            }
          });

          // Gestion des favoris
          favoritesList.addEventListener("click", async (e) => {
            if (e.target.classList.contains("goFav")) {
              const id = e.target.dataset.id;
              const park = app.parkCtrl.parkings.find((p) =>
                p.parking_id == id
              );
              if (park) {
                app.nearestParking = park;
                app.map.setNearestParkingMarker(park);
                app.startTracking();
              }
            } else if (e.target.classList.contains("removeFav")) {
              const id = e.target.dataset.id;
              const resp = await fetch("./vue/remove_favorite.php", {
                method: "POST",
                credentials: "include",
                headers: { "Content-Type": "application/json" },
                body: JSON.stringify({ parkingId: id }),
              });
              const result = await resp.json();
              if (result.success) {
                data.favorites = data.favorites.filter((f) =>
                  f.parking_id != id
                );
                renderFavorites();
              }
            }
          });
        } catch (err) {
          console.error("Erreur initialisation :", err);
          alert("Impossible de charger l'application.");
        } finally {
          loader.style.display = "none";
        }
      }

      initApp();
    </script>
  </body>
</html>
