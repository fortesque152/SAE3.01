<!DOCTYPE html>
<html lang="fr">

<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Parking-SAE</title>
  <link rel="icon" href="./vue/style/Logo.png" />
  <link rel="stylesheet" href="./api/leaflet/dist/leaflet.css" />
  <link rel="stylesheet" href="./vue/style/style.css" />
</head>

<body>
  <div id="loaderContainer">
    <span id="loader"></span>
    <h4>Chargement en cours...</h4>
  </div>

  <div id="map"></div>
  <div id="routeInfo"></div>
  <button id="routeBtn">Aller au parking le plus proche</button>

  <script src="./api/leaflet/dist/leaflet.js"></script>

  <script type="module">
    import { MobileApp } from "./module/MobileApp.js";
    import { UserProfile } from "./module/modele/UserProfile.js";

    async function initApp() {
      try {
        // 1️⃣ Récupérer le profil utilisateur depuis PHP
        const res = await fetch("./vue/get_profile.php", { credentials: "include" });
        const data = await res.json();

        if (!data.connected) {
          alert("Utilisateur non connecté. Veuillez vous connecter.");
          window.location.href = "connexion.php";
          return;
        }

        // 2️⃣ Créer un UserProfile à partir des données PHP
        const user = new UserProfile({
          name: data.profile.name,
          surname: data.profile.surname,
          vehicleType: data.profile.vehicleType,
          preferences: data.profile.preferences || []
        });

        // 3️⃣ Instancier l'application avec le profil utilisateur
        const app = new MobileApp(user);
        await app.start();

        // 4️⃣ Gestion du bouton itinéraire
        const routeBtn = document.getElementById("routeBtn");
        const routeInfo = document.getElementById("routeInfo");

        routeBtn.addEventListener("click", async () => {
          if (!app.userPos || !app.nearestParking) {
            alert("Position en cours de récupération");
            return;
          }

          app.map.setNearestParkingMarker(app.nearestParking);
          app.startTracking();

          routeBtn.disabled = true;
          routeBtn.textContent = "Itinéraire affiché";

          const result = await app.showRoute(app.userPos, app.nearestParking.location);
          if (result) {
            routeInfo.textContent = `Distance : ${result.distanceKm} km | Durée : ${result.duration}`;
            routeInfo.style.display = "block";
          }
        });

      } catch (err) {
        console.error("Erreur lors de l'initialisation de l'application :", err);
        alert("Impossible de charger l'application. Vérifiez le serveur.");
      }
    }

    // Lancer l'application
    initApp();
  </script>
</body>

</html>
